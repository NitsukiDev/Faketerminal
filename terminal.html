<!DOCTYPE html>
<html lang="cs">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Falešný Terminál</title>

<style>
body{
  margin:0; font-family:Arial; background:#111; color:#fff; display:flex;
  justify-content:center; align-items:center; height:100vh; text-align:center;
}
.screen{ display:none; flex-direction:column; gap:15px; }
.active{ display:flex; }
input[type=number]{ width:120px; padding:5px; font-size:20px; text-align:center; }
.btn{ padding:10px 20px; background:#0a0; border:none; font-size:20px; color:#fff; }
.pinpad{ display:flex; flex-wrap:wrap; justify-content:center; gap:10px; }
.pinbtn{ width:60px; height:60px; font-size:25px; background:#333; color:#fff; border:none; border-radius:5px; }
.pin-display{ font-size:30px; letter-spacing:10px; }
.light{ width:20px; height:20px; border-radius:50%; background:#222; display:inline-block; }
.activeLight{ background:lime; }
</style>

<body>

<!-- MENU -->
<div id="menu" class="screen active">
  <h2>Nastavení platby</h2>
  <div>Částka: <input type="number" id="amountInput" value="30"></div>
  <label><input type="checkbox" id="pinCheckbox"> Vyžadovat PIN</label>
  <label><input type="checkbox" id="rejectCheckbox"> Zamítnout platbu</label>
  <button id="startBtn" class="btn">Požádat o platbu</button>
</div>

<!-- TERMINAL -->
<div id="terminal" class="screen">
  <h2 id="statusText">Přiložte kartu</h2>
  <div>
    <span class="light"></span>
    <span class="light"></span>
    <span class="light"></span>
    <span class="light"></span>
  </div>
  <h2 id="amountDisplay"></h2>
</div>

<!-- PINPAD -->
<div id="pinScreen" class="screen">
  <h2 id="pinTitle">Zadejte PIN</h2>
  <div class="pin-display" id="pinDisplay"></div>
  <div class="pinpad" id="pinpad"></div>
  <button id="confirmPin" class="btn">Potvrdit</button>
</div>

<!-- RESULT -->
<div id="resultScreen" class="screen">
  <h1 id="resultIcon"></h1>
  <h2 id="resultText"></h2>
</div>

<audio id="beep" src="TerminalBeep.mp3"></audio>

<script>
let reject = false
let requirePin = false
let pin = ""
const lights = document.querySelectorAll('.light')
const statusText = document.getElementById("statusText")
const amountDisplay = document.getElementById("amountDisplay")
const menu = document.getElementById("menu")
const terminal = document.getElementById("terminal")
const pinScreen = document.getElementById("pinScreen")
const resultScreen = document.getElementById("resultScreen")
const pinCheckbox = document.getElementById("pinCheckbox")
const rejectCheckbox = document.getElementById("rejectCheckbox")
const pinDisplay = document.getElementById("pinDisplay")
const beep = document.getElementById("beep")

function sleep(ms){ return new Promise(r => setTimeout(r, ms)) }

async function startNFC(){
  try{
    const ndef = new NDEFReader()
    await ndef.scan()
    ndef.onreading = async () => {
      beep.play()
      navigator.vibrate(100)
      await processCard()
    }
  }catch(e){
    statusText.textContent = "NFC chyba"
  }
}

startNFC()

document.getElementById("startBtn").onclick = () => {
  reject = rejectCheckbox.checked
  requirePin = pinCheckbox.checked
  menu.classList.remove('active')
  terminal.classList.add('active')
  amountDisplay.textContent = document.getElementById("amountInput").value + " CZK"
}

async function processCard(){
  statusText.textContent = "Načítám kartu…"
  await sleep(2000)

  if(requirePin){
    showPin()
  } else finishAfterProcess()
}

function showPin(){
  terminal.classList.remove('active')
  pinScreen.classList.add('active')
  document.getElementById("pinTitle").textContent =
    "Zadejte PIN " + amountDisplay.textContent
}

document.getElementById("confirmPin").onclick = async () => {
  if(pin.length < 4) return
  pinScreen.classList.remove('active')
  terminal.classList.add('active')

  statusText.textContent = "Přijímám…"
  await sleep(1000)
  statusText.textContent = "Odesílám…"
  await sleep(1000)
  statusText.textContent = "Přijímám…"
  await sleep(1000)
  statusText.textContent = "Odesílám…"
  await sleep(1000)
  finishAfterProcess()
}

async function finishAfterProcess(){
  terminal.classList.remove('active')
  resultScreen.classList.add('active')

  if(reject){
    document.getElementById("resultIcon").textContent = "❌"
    document.getElementById("resultText").textContent = "Platba Zamítnuta, Nedostatek zůstatku."
  }else{
    document.getElementById("resultIcon").textContent = "✔️"
    document.getElementById("resultText").textContent = "Schváleno"
  }
  await sleep(4000)
  location.reload()
}

// PIN PAD GENERATION
const pad = document.getElementById("pinpad")
const nums = [1,2,3,4,5,6,7,8,9,"←",0,"OK"]
nums.forEach(n=>{
  const b = document.createElement("button")
  b.className = "pinbtn"
  b.textContent = n
  b.onclick = ()=>{
    if(n==="←"){ pin = pin.slice(0,-1) }
    else if(typeof n==="number" && pin.length<4){ pin+=n }
    pinDisplay.textContent = "*".repeat(pin.length)
  }
  pad.appendChild(b)
})
</script>

</body>
</html>
